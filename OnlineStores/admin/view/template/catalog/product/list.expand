
<style type="text/css">
    .modal-dialog-centered{
        -webkit-box-align:center;
        -ms-flex-align:center;
        align-items:center;
        min-height:calc(100% - 1rem)
    }
    .modal-dialog-centered{display:-webkit-box;display:-ms-flexbox;display:flex}
    .modal-dialog-centered{min-height:calc(100% - 3.5rem)}

    .foreign-key-blue {
        background-color: #e9eef9;
    }
    .rounded{
      border-radius: 3px;
    }
    .px-half {
      padding-left: .25rem;
      padding-right: .25rem;
    }

    .flex-none {
        -webkit-box-flex: 0;
        -webkit-flex: none;
        -ms-flex: none;
        flex: none;
    }
    .mr-half {
      margin-right: .25rem;
    }

    .flex-inline {
        display: -webkit-inline-flex;
        display: -ms-inline-flexbox;
        display: inline-flex;
    }

    .items-center {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        -ms-grid-row-align: center;
        align-items: center;
    }
    .fit {
        max-width: 100%;
    }
    .truncate {
        /*max-width: 100%;*/
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .line-height-4 {
        line-height: 1.5;
    }

    .text-dark, a.text-dark, .text-dark a {
        color: hsl(0,0%,20%);
        fill: hsl(0,0%,20%);
    }

    .cursor-pointer, .pointer {
        cursor: pointer;
    }

    .flex-auto {
        -webkit-box-flex: 1;
        -webkit-flex: 1 1 auto;
        -ms-flex: 1 1 auto;
        flex: 1 1 auto;
        min-width: 0;
        min-height: 0;
    }
    .flex {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
    }

    .overflow-hidden {
        overflow: hidden;
    }

    .p-half {
        padding: .25rem;
    }

    .selected-category-row {
        box-sizing: content-box;
        border: 1px solid transparent;
        margin-top: -1px;
        padding-right: 0;
        border-right: 0;
        box-shadow: 0 0 0 2px #2d7ff9 !important;
        border-radius: 1px;
        z-index: 100000 !important;
    }
      .normal {
    /*    border-bottom: 1px solid hsl(202,10%,88%);
        border-left: 1px solid hsl(202,10%,88%);*/
    /*    border-right: none;
        border-top: none;*/
        top: 0;
        overflow: visible;
        /*border-left-color: #f3f3f3;*/
      }
      .flex-wrap {
        -webkit-flex-wrap: wrap;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
      }
      .m-half {
        margin: .25rem;
      }
      .content-start {
        -webkit-align-content: flex-start;
        -ms-flex-line-pack: start;
        align-content: flex-start;
        max-height: 3em;
        position: relative;
      }
    div.expandButton {
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        position: absolute;
        width: 16px;
        height: 16px;
        z-index: 2;
    }
    div.dotsButton {
      position: absolute; 
      z-index: 2;
      width: 16px;
      height: 16px;
    }

      .white, .white-focus:focus, .white-hover:hover {
        background-color: #fff;
      }

      .text-blue, a.text-blue, .text-blue-active:active, .text-blue-focus:focus, .focus-container:focus .text-blue-focus, .baymax a.text-blue, .text-blue a, .baymax .text-blue a {
        color: #2d7ff9;
        fill: #2d7ff9;
      }
      .justify-center {
        -webkit-box-pack: center;
        -webkit-justify-content: center;
        -ms-flex-pack: center;
        justify-content: center;
      }
      .cell {
        /*position: absolute;*/
        font-size: 13px;
        /*height: 32px;*/
        padding: 0;
        margin: 0;
        vertical-align: top;
        /*background: white;*/
        color: #111111;
        cursor: default;
        outline: none;
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-flex-wrap: wrap;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
      }
    .py1 {
        padding-top: .5rem;
        padding-bottom: .5rem;
      }
  .overflow-auto {
    overflow: auto;
  }
  .light-scrollbar::-webkit-scrollbar {
    width: 12px;
    height: 12px;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }
  .light-scrollbar::-webkit-scrollbar-button {
    display: none;
    height: 0;
    width: 0;
  }
  .light-scrollbar::-webkit-scrollbar-thumb {
    background-color: hsla(0,0%,0%,0.35);
    background-clip: padding-box;
    border: 3px solid rgba(0,0,0,0);
    border-radius: 6px;
    min-height: 36px;
  }

  .relative {
    position: relative;
  }

  .white, .white-focus:focus, .white-hover:hover {
    background-color: #fff;
  }
  .p1 {
    padding: .5rem;
  }
  .flex-none {
    -webkit-box-flex: 0;
    -webkit-flex: none;
    -ms-flex: none;
    flex: none;
  }

  .baymax * {
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
  }
  .rounded-big-right {
    border-top-right-radius: 6px;
    border-bottom-right-radius: 6px;
  }

  .cell.expanded {
    /*position: fixed !important;*/
    width: 387px;
    height: auto;
    /*background-color: #f9f9f9;*/
    /*box-shadow: 0 0 0 2px rgba(0,0,0,0.1);*/
    /*border-radius: 6px;*/
    /*padding: 24px;*/
    display: block;
    z-index: 10001;
    opacity: 1;
    overflow: visible;
  }
  .mb2 {
    margin-bottom: 1rem;
  }
  .overflow-hidden {
    overflow: hidden;
  }

    .button-stroked1 {
        box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
    }

    .big {
        font-size: 1.2rem;
    }
    .rounded-big-right {
    border-top-right-radius: 6px;
    border-bottom-right-radius: 6px;
    }
</style>


<div class="container-detached">
    <div class="content-detached">
        <!-- Grid -->

        <div id="insertWizard" class="modal">
            <div class="modal-dialog modal-full">
                <div class="modal-content">

                    <div class="modal-body"></div>

                </div>
            </div>
        </div>

        {% set dropna_timer = 0 %}
        <div class="alert alert-info" id="dropna_alert" style="display: {% if dropna_import and not dropna_import_closed %} block {% else %} none {% endif %}">
                <strong style="color: #ffa62f;display: none;" id="dropna_wait">{{ lang('text_wait') }} </strong> &nbsp;
                <i class="fa fa-exclamation-circle"></i> 
                {% if dropna_import_progress %}
                    {% set dropna_timer = 1 %}
                    {{ lang('text_dropna_export') }} <strong><span id="dropna_imported">{{ dropna_import_success }}</span></strong> {{ lang('text_of') }} <strong><span id="dropna_all">{{ dropna_import_total }}</span></strong> {{ lang('text_exported') }}! <span style="font-size: 10px">({{ lang('text_dropna_update') }})</span>
                {% else %}
                    {{ lang('text_dropna_export') }} {{ lang('text_dropna_success') }}: <strong>{{ dropna_import_success }}</strong>, {{ lang('text_dropna_failed') }}: <strong>{{ dropna_import_failed }}</strong>
                    <button type="button" class="close" data-dismiss="alert" onclick="updateDropnaAlert()">&times;</button>
            {% endif %}
        </div>


        <div class="tab-pane fade in active" id="gridView">
            <div class="features-table-container rounded">
                <div class="collapse in">
                    <table id="datatableGrid" class="table table-hover datatable-highlight">
                        <thead>
                            <tr>
                                <th>Hmm?</th>
                                <th>{{ lang('column_image') }}</th>
                                <th>{{ lang('column_name') }}</th>
                                <th>{{ lang('column_categories') }}</th>                        
                                <th>{{ lang('column_model') }}</th>
                                <th>{{ lang('barcode') }}</th>
                                <th>{{ lang('column_price') }}</th>
                                <th>{{ lang('column_order_quantity') }}</th>
                                <th>{{ lang('column_quantity') }}</th>
                                <th>{{ lang('column_status') }}</th>
                                <th>{{ lang('sku')|upper }}</th>
                                <th>{{ lang('entry_date_added') }}</th>
                                {% if is_multiseller %} <th> {{lang('seller')}}</th> {% endif %}
                                <th class="do-not-export-excel do-not-export-pdf do-not-export-csv"></th>
                                <th class="do-not-export-excel do-not-export-pdf do-not-export-csv"></th>
                                <th class=""></th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        {% if products is defined and products|length > 800000 %}
            {% set row = 1 %}
            {% for product in products %}

                {% if row == 4 %}
                    <div class="row">
                {% endif %}

                <div class="col-lg-3 col-sm-6">
                    <div class="panel">
                        <div class="panel-body">
                            <div class="thumb thumb-fixed">
                                <a href="{{ product['image'] }}" data-popup="lightbox">
                                    <img src="{{ product['image'] }}" alt="">
                                    <span class="zoom-image"><i class="icon-plus2"></i></span>
                                </a>
                            </div>
                        </div>

                        <div class="panel-body panel-body-accent text-center">
                            <h6 class="text-semibold no-margin">
                                <a href="{{ product['links']['update'] }}"
                                   class="text-default">{{ product['name'] }}</a>
                            </h6>

                            <ul class="list-inline list-inline-separate mb-10">
                                <li>
                                    <a href="{{ link('catalog/category/update?category_id=' ~ product['category_id']) }}"
                                       class="text-muted">
                                        {{ product['category_name'] ?: '&ensp;' }}
                                    </a>
                                </li>
                            </ul>

                            <h3 class="no-margin text-semibold">{{ product['price'] }}</h3>

                            {% if product['reviews']['count'] is defined %}
                                <div class="text-nowrap">
                                    {% for i in 1..5 %}
                                        {% if i >= product['reviews']['rate'] %}
                                            <i class="icon-star-full2 text-size-base text-warning-300"></i>
                                        {% else %}
                                            <i class="icon-star-empty3 text-size-base text-warning-300"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                {% if product['reviews']['count'] > 10 %}
                                    <div class="text-muted">{{ product['reviews']['count'] }} {{ lang('reviews_label') }}</div>
                                {% else %}
                                    <div class="text-muted">{{ product['reviews']['count'] }} {{ lang('review_label') }}</div>
                                {% endif %}
                            {% else %}
                                <div class="text-nowrap">
                                    <i>&ensp;</i>
                                </div>

                                <div class="text-muted">&ensp;</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if row == 4 %}
                    </div>
                {% endif %}

                {% set row = row + 1 %}
            {% endfor %}
        {% endif %}

        <!-- /grid -->


        <!-- Pagination -->
        <div class="hide text-center content-group-lg pt-20">
            {{ pagination }}
            <ul class="hide pagination">
                <li class="disabled"><a href="#"><i class="icon-arrow-small-right"></i></a></li>
                <li class="active"><a href="#">1</a></li>
                <li><a href="#">2</a></li>
                <li><a href="#">3</a></li>
                <li><a href="#">4</a></li>
                <li><a href="#">5</a></li>
                <li><a href="#"><i class="icon-arrow-small-left"></i></a></li>
            </ul>
        </div>
        <!-- /pagination -->

    </div>

    {% include 'catalog/product/modals/mass-category.expand' with {categories: categories} %}
    {% include 'catalog/product/modals/apply_tax_class.expand' with {tax_classes: tax_classes} %}
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        {# <h5 class="modal-title" id="exampleModalCenterTitle">Modal title</h5> #}
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div class="cell expanded">
            <div id="items" class="py1 overflow-auto light-scrollbar" style="max-height: 400px; padding-left: 2px; padding-right: 10px; overflow-x: hidden;">
                     

            </div>
          </div>
      </div>
    </div>
  </div>
</div>

<script>
    var links = {};
    var configs = {};

    var insertWizard = '{{ insertWizard }}';
    let quantity = new URL(location.href).searchParams.get("quantity");
    if (quantity === "0"){
        links['dtHandler'] = '{{ link('catalog/product/getXHRList?view=list&quantity=') }}' +quantity;
    }else {
        links['dtHandler'] = '{{ link('catalog/product/getXHRList?view=list') }}';
    }
    links['dtUpdateStatus'] = '{{ link("catalog/product/dtUpdateStatus") }}';
    links['dtDelete'] = '{{ link('catalog/product/dtDelete') }}';
    links['backgroundDelete'] = '{{ link('catalog/product/backgroundDeleteProcess') }}';   
    links['insert'] = '{{ link('catalog/product/insert') }}';
    links['update'] = '{{ link('catalog/product/update') }}';
    links['copy'] = '{{ link('catalog/product/copy') }}';
    links['send'] = '{{ link('catalog/product/send') }}';
    links['mass_edit'] = '{{ link('catalog/product/massEdit') }}';
    links['preview'] = '{{ linkfront('product/product', 'product_id=') }}';
    links['categories_autocomplete'] = '{{ link('catalog/category/autocomplete') }}';
    links['mass_category_update_link'] = '{{ link('catalog/product/massCategoryUpdate') }}';
    links['dropnaExport'] = '{{ link('catalog/product/dropnaExport') }}';
    links['dropnaScheduleDt'] = '{{ link('catalog/product/dropnaScheduleDt') }}';
    links['updateDropnaAlert'] = '{{ link('catalog/product/updateDropnaAlert') }}';

    configs['config_admin_limit'] = '{{ config('config_admin_limit') ?  config('config_admin_limit') : 10 }}';

    var showOrderProductQuantity = {{ show_order_product_quantity }}
    var is_supplier     = {{ is_supplier ? 1 : 0 }};
    var is_multiseller  = {{ is_multiseller ? 1 : 0 }};
    var dropna_timer    = {{ dropna_timer ? 1 : 0 }};
</script>

<!-- Include Handlebars from a CDN -->
<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<script id="category-panel-template" type="text/x-handlebars-template">
    <div style="width: 280px; left: 249px; z-index: 3;" class="cell normal pointer">
      <div class="flex flex-auto overflow-hidden foreignRecordRendererContainer p-half">
        {{ '{{{ items }}}' }}
      </div>
    </div>
</script>

<script id="category-item" type="text/x-handlebars-template">
    <div class="foreign-key-blue rounded px-half flex-none mr-half flex-inline items-center fit truncate line-height-4 text-dark" style="height:22px" id="{{ '{{id}}' }}" image="{{ '{{image}}' }}">{{ '{{ category_name }}' }}</div>
</script>

<script id="modal-item" type="text/x-handlebars-template">
    
    <div class="flex relative white rounded mb2 button-stroked1 pointer" style="background-color: #f9f9f9;">
        <div class="flex-auto flex">
          <div class="flex-auto p1">
            <div class="flex-inline col-12">
              <div class="col-12 mb1 strong big truncate line-height-4">
                <a class="text-dark" href="{{ link('catalog/category/update?category_id=' ~ '{{ id }}' ) }}">{{ '{{ name }}' }}</a>
              </div>
            </div>
          </div>
        </div>
    </div>

</script>

<script src="view/javascript/pages/catalog/product/list.js?bn={{ BuildNumber }}"></script>

<script>
    $( "#datatableGrid" ).on( "click", ".cell", function() {
    //remove selection from any other
    deselect();

    //set selection to this
    $(this).addClass("selected-category-row");
    $(this).removeClass("normal");

    $('.foreignRecordRendererContainer', this).removeClass("p-half");
    $('.foreignRecordRendererContainer', this).removeClass("overflow-hidden");

    $('.selected-category-row').find('.foreign-key-blue').wrapAll('<div class="overflow-hidden flex-auto flex flex-wrap m-half content-start" style="min-height: 22px;">');
    $('.selected-category-row').find('.content-start' ).prepend('<div class="expandButton rounded white pointer text-blue flex items-center justify-center" data-toggle="modal" data-target="#exampleModalCenter"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12" class="icon" style="shape-rendering: geometricprecision;"><path fill-rule="evenodd" class="" fill="currentColor" d="M7.75 5.25l.823.823A.25.25 0 0 0 9 5.896V3.5a.5.5 0 0 0-.5-.5H6.104a.25.25 0 0 0-.177.427l.823.823-2.5 2.5-.823-.823A.25.25 0 0 0 3 6.104V8.5a.5.5 0 0 0 .5.5h2.396a.25.25 0 0 0 .177-.427L5.25 7.75l2.5-2.5zM3 .988h6a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2z"></path></svg></div>');

    if ($(this).find('.content-start').height() < $(this).find('.content-start').prop('scrollHeight') ||
        $(this).find('.content-start').width() < $(this).find('.content-start').prop('scrollWidth')) {
        // your element have overflow
        $('.selected-category-row').find('.content-start' ).append('<div class="dotsButton rounded darken1-hover pointer flex-inline items-center justify-center" data-toggle="modal" data-target="#exampleModalCenter"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12" class="icon" style="shape-rendering: geometricprecision;"><path fill-rule="evenodd" class="" fill="currentColor" d="M10.5,8 C9.67157288,8 9,7.32842712 9,6.5 C9,5.67157288 9.67157288,5 10.5,5 C11.3284271,5 12,5.67157288 12,6.5 C12,7.32842712 11.3284271,8 10.5,8 Z M6,8 C5.17157288,8 4.5,7.32842712 4.5,6.5 C4.5,5.67157288 5.17157288,5 6,5 C6.82842712,5 7.5,5.67157288 7.5,6.5 C7.5,7.32842712 6.82842712,8 6,8 Z M1.5,8 C0.671572875,8 0,7.32842712 0,6.5 C0,5.67157288 0.671572875,5 1.5,5 C2.32842712,5 3,5.67157288 3,6.5 C3,7.32842712 2.32842712,8 1.5,8 Z"></path></svg></div>');
    }
    });


    $(document).on('click', function (e) {
    if ($(e.target).closest(".selected-category-row").length === 0) {
        deselect();      
    }
    });

    const deselect = ()=>{
    $('.selected-category-row').addClass("normal");

    $('.selected-category-row .foreignRecordRendererContainer').addClass("p-half");
    $('.selected-category-row .foreignRecordRendererContainer').addClass("overflow-hidden");

    $('.selected-category-row .foreign-key-blue').unwrap();
    $('.selected-category-row .expandButton').remove();
    $('.selected-category-row .dotsButton').remove();
    $('.selected-category-row').removeClass("selected-category-row");
    }

    $('#exampleModalCenter').on('show.bs.modal', function(e) {
        let template;
        var templateScript;
        var context;
        var items_html = '';

        $( '.selected-category-row').find('.foreign-key-blue' ).each(function( index ) {
            template = $('#modal-item').html();
            templateScript = Handlebars.compile(template);

            context = {
                'name' : decodeHtml( $(this).html() ), //decode HTML 
                'id'   : $(this).attr('id'),
                'image': $(this).attr('image')
                };
            items_html += templateScript(context);
        });

        $('#exampleModalCenter').find('#items').html(items_html);
    });


    function decodeHtml(html) {
        var txt = document.createElement("textarea");
        txt.innerHTML = html;
        var output = txt.value;
        txt.remove();
        return output;
    }
</script>
